version: 2.1

orbs:
  utils: ethereum-optimism/circleci-utils@1.0.22

jobs:
  docs-build:
    docker:
      - image: cimg/rust:1.84.0
    resource_class: medium
    steps:
      - utils/checkout-with-mise:
          checkout-method: blobless
      - run:
          name: Generate book source
          command: uv run gen.py
          working_directory: book/gen
      - run:
          name: Build book
          command: mdbook build
          working_directory: book
      - persist_to_workspace:
          root: book
          paths:
            - book

  docs-deploy:
    docker:
      - image: cimg/rust:1.84.0
    resource_class: medium
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - add_ssh_keys:
          fingerprints:
            - "SHA256:dXP2B12YLfrLIQiu+iyCYL3QyNK0dSPpucy+TA+0qtg"
      - checkout
      - run:
          name: Set up Git
          command: |
            git config --global user.email "optibot@oplabs.co"
            git config --global user.name "OptiBot"
            git rev-parse --short HEAD > COMMIT.txt
            git checkout gh-pages
      - run:
          name: Copy contents
          command: cp -r /tmp/workspace/book/* .
      - run:
          name: Commit changes
          command: |
            COMMIT=$(cat COMMIT.txt)
            rm COMMIT.txt
            git status
            git add .
            git commit -m "Update book based on $COMMIT"
            git push origin gh-pages

workflows:
  pr:
    jobs:
      - docs-build:
          context:
            - circleci-repo-readonly-authenticated-github-token
      - docs-deploy:
          filters:
            branches:
              only:
                - main
          requires:
            - docs-build